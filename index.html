<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Reproducible computation at scale in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Will Landau" />
    <link href="index_files/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="footer-header.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Reproducible computation at scale in R
### Will Landau

---


layout: true



## Purpose: manage long runtimes

&lt;center&gt;
&lt;img src = "./images/infographic.svg" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

&lt;div class="my-footer"&gt;&lt;span&gt;xaringan power    
&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;
&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;
yolo&lt;/span&gt;&lt;/div&gt; 

---

## Data analysis workflows can be complicated.
&lt;center&gt;
&lt;img src = "./images/workflow.png" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## When you go back and change something...
&lt;center&gt;
&lt;img src = "./images/change.png" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## ...everything downstream is **no longer valid**.

&lt;center&gt;
&lt;img src = "./images/downstream.png" align="middle" style="border: none; box-shadow: none; text-align: center;"&gt;
&lt;/center&gt;

---

## Do you rerun **everything** from scratch?

- Takes too long.
- Too frustrating.

&lt;center&gt;
&lt;img src = "./images/sisyphus.svg" align="middle" style="border: none; box-shadow: none; height: 375px; text-align: center;"&gt;
&lt;div style="font-size: 0.5em; text-align: center"&gt;&lt;a href="https://openclipart.org/detail/275842/sisyphus-overcoming-silhouette"&gt;https://openclipart.org/detail/275842/sisyphus-overcoming-silhouette&lt;/a&gt;&lt;/div&gt;
&lt;/center&gt;

---

## Do you manually hunt for pieces to update?

- Messy and prone to human error.
- Not reproducible.

&lt;center&gt;
&lt;img src = "./images/mess.svg" align="middle" style="border: none; box-shadow: none; height: 400px; text-align: center;"&gt;
&lt;div style="font-size: 0.5em; text-align: center;"&gt;&lt;a href="https://openclipart.org/detail/216179/messy-desk"&gt;https://openclipart.org/detail/216179/messy-desk&lt;/a&gt;&lt;/div&gt;
&lt;/center&gt;

---

## Pipeline toolkits solve this problem.

- Sophisticated, vibrant, active space of tools: [github.com/pditommaso/awesome-pipeline](https://github.com/pditommaso/awesome-pipeline).
- Most are language-agnostic or designed for other languages.
- [**`drake`**](https://github.com/ropensci/drake) is uniquely devoted to R.
    - A focus on ordinary R functions and variables rather than cumbersome files.
    - Heavy use of the data frame, even as a substitute for the  traditional [Makefile](https://www.gnu.org/software/make).
    - Native [tidy evaluation](https://tidyeval.tidyverse.org) support.
    - A [domain-specific language (DSL)](http://adv-r.had.co.nz/dsl.html) for [creating large workflows](https://ropenscilabs.github.io/drake-manual/plans.html#large-plans).

---

## Example uses in the pharmaceutical industry

&lt;br&gt;

- Clinical trial modeling and simulation
- Subgroup identification
- Bayesian network meta analysis
- Graph-based multiple comparison procedures
- Bayesian networks in genomics
- PK/PD modeling (e.g. [`mrgsolve`](https://github.com/metrumresearchgroup/mrgsolve))
- **Deep learning**

---

## Example deep learning workflow

- Goal: predict customers who cancel their subscriptions with a telecom company.
- Data: [IBM Watson Telco Customer Churn dataset](https://www.ibm.com/communities/analytics/watson-analytics-blog/predictive-insights-in-the-telco-customer-churn-data-set/).
- Workflow principles generalize to pharma, e.g. business analytics and genomics problems.

&lt;img src = "./images/combine.png" style="border: none; box-shadow: none; height: 200px"&gt;

&lt;div style="font-size: 0.5em;"&gt;&lt;a href="https://openclipart.org/detail/90739/newplus"&gt;https://openclipart.org/detail/90739/newplus&lt;/a&gt;, &lt;a href="https://github.com/rstudio/keras"&gt;https://github.com/rstudio/keras&lt;/a&gt;&lt;/div&gt;

---

## File structure

&lt;br&gt;
&lt;br&gt;


```r
make.R
R/
├── packages.R
├── functions.R
└── plan.R
data/
└── customer_churn.csv
```

---

## `packages.R`


```r
# packages.R
library(drake)
library(keras)
library(recipes)
library(rsample)
library(tidyverse)
library(yardstick)
```

---

## `functions.R`


```r
# functions.R
prepare_recipe &lt;- function(data) {
  # ... 
}

define_model &lt;- function(churn_recipe) {
  # ...
}

fit_model &lt;- function(data, churn_recipe, model_file) {
  # ...
}

get_conf_matrix &lt;- function(data, churn_recipe, model_file) {
  # ...
}
```

---

## `plan.R`


```r
# plan.R
plan &lt;- drake_plan(
* data = read_csv(
    file_in("data/customer_churn.csv"),
    col_types = cols()
  ) %&gt;%
    initial_split(prop = 0.3),
* churn_recipe = prepare_recipe(data),
* history = fit_model(data, churn_recipe, file_out("model.h5")),
* history_plot = plot(history),
* conf_matrix = get_conf_matrix(
    data,
    churn_recipe,
    file_in("model.h5")
  ),
* report_step = rmarkdown::render(
    knitr_in("results.Rmd"),
    output_file = file_out("results.html"),
    quiet = TRUE
  )
)
```

---

## The plan is a data frame.


```r
plan
```

---

## The workflow

&lt;img src = "./images/tensorflowflow.png" style="border: none; box-shadow: none; height: 250px"&gt;

---

## Run the project in `make.R`


```r
# make.R
source("R/packages.R")
source("R/functions.R")
source("R/plan.R")

make(plan)
```

---

## Inspect the results.


```r
readd(history_plot) # See also loadd()
```

---

## Update the plan.


```r
# plan.R
plan &lt;- drake_plan(
  data = read_csv(
    file_in("data/customer_churn.csv"),
    col_types = cols()
  ) %&gt;%
    initial_split(prop = 0.3),
  churn_recipe = prepare_recipe(data),
  history = fit_model(data, churn_recipe, file_out("model.h5")),
  history_plot = plot(history) +
*   theme_bw(),
  conf_matrix = get_conf_matrix(
    data,
    churn_recipe,
    file_in("model.h5")
  ),
  report_step = rmarkdown::render(
    knitr_in("results.Rmd"),
    output_file = file_out("results.html"),
    quiet = TRUE
  )
)
```



---

## `vis_drake_graph()`

&lt;img src = "./images/visdrakegraph.png" style="border: none; box-shadow: none; height: 300px"&gt;

---

## Refresh the results.


```r
# make.R
source("R/packages.R")
source("R/functions.R")
source("R/plan.R") # modified

make(plan)
```

---

## See updated results.


```r
readd(history_plot)
```

---

## Continue iterating to improve the model...


```r
readd(conf_matrix)
```

---

## Evidence of reproducibility.


```r
# make.R
source("R/packages.R")
source("R/functions.R")
source("R/plan.R")

make(plan)
```

- See also `outdated()`.

---

## Scale up the number of models.


```r
dataset_index &lt;- seq_len(50)

plan &lt;- drake_plan(
  data = target(
    download_dataset(from),
*   transform = map(from = !!dataset_index)
  ),
  history = target(
    fit_my_model(data, learning_rate = lr),
*   transform = cross(data, lr = c(1e-5, 1e-4, 1e-3))
  ),
  best = target(
    get_best_model(history),
*   transform = combine(history)
  )
)
```

---

## Scale up the number of models.


```r
plan
```

---

## `drake_ggraph()` for large graphs



---

## High-performance computing.


```r
# make.R

# template file with configuration
drake_hpc_template_file("slurm_clustermq.tmpl")

# Use SLURM resource manager with the template.
options(
  clustermq.scheduler = "slurm",
  clustermq.template = "slurm_clustermq.tmpl"
)

# make() is the basically the same.
make(plan, jobs = 2, parallelism = "clustermq")
```

---

## High-performance computing.

&lt;iframe width="800" height="450" src="https://www.powtoon.com/embed/bUfSIaXjrw5/" frameborder="0"&gt;&lt;/iframe&gt;

---

## Resources


```r
install.packages("drake")                  # release
devtools::install_github("ropensci/drake") # development
```

- [Today's code](https://github.com/wlandau/drake-examples/tree/master/deep-learning): `drake_example("deep-learning")`
- [Reference website](https://ropensci.github.io/drake/)
- [Full user manual](https://ropenscilabs.github.io/drake-manual/)
- [Example workflows](https://github.com/wlandau/drake-examples)
- [File an issue](https://github.com/ropensci/drake/issues).
- [Contribute code](https://github.com/ropensci/drake/pulls).
- [Discuss at rOpenSci.org](https://discuss.ropensci.org).

---

## Today's example

&lt;br&gt;
&lt;br&gt;
&lt;table style = "border: none"&gt;
&lt;tr&gt;
&lt;td style = "padding-right: 125px"&gt;
&lt;ul style&gt;
&lt;img src = "./images/edgar.jpg" style="border: none; box-shadow: none; height: 150px"&gt;
&lt;li&gt;&lt;a href = "https://github.com/edgararuiz"&gt;Edgar Ruiz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/sol-eng/tensorflow-w-r/blob/master/workflow/tensorflow-drake.Rmd"&gt;example code&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;td&gt;
&lt;ul&gt;
&lt;img src = "./images/matt.jpg" style="border: none; box-shadow: none; height: 150px"&gt;
&lt;li&gt;&lt;a href = "https://github.com/mdancho84"&gt;Matt Dancho&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://blogs.rstudio.com/tensorflow/posts/2018-01-11-keras-customer-churn/"&gt;blog post&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

---

## Development

&lt;table style = "border: none"&gt;
&lt;tr&gt;
&lt;td&gt;
&lt;br&gt;
&lt;ul&gt;
&lt;img src = "./images/ropensci.png" style="border: none; box-shadow: none; height: 150px"&gt;
&lt;li&gt;&lt;a href = "https://github.com/maelle"&gt;Maëlle Salmon&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/benmarwick"&gt;Ben Marwick&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/jules32"&gt;Julia Lowndes&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/gothub"&gt;Peter Slaughter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/jennybc"&gt;Jenny Bryan&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/richfitz"&gt;Rich FitzJohn&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/stefaniebutland"&gt;Stefanie Butland&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;td&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href = "https://github.com/jarad"&gt;Jarad Niemi&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/krlmlr"&gt;Kirill Müller&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/HenrikBengtsson"&gt;Henrik Bengtsson&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/mschubert"&gt;Michael Schubert&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/kendonB"&gt;Kendon Bell&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/milesmcbain"&gt;Miles McBain&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/pat-s"&gt;Patrick Schratz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/AlexAxthelm"&gt;Alex Axthelm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/dapperjapper"&gt;Jasper Clarkberg&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/BListyg"&gt;Ben Listyg&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/tjmahr"&gt;TJ Mahr&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/aedobbyn"&gt;Amanda Dobbyn&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/tiernanmartin"&gt;Tiernan Martin&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/bpbond"&gt;Ben Bond-Lamberty&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/tmastny"&gt;Tim Mastny&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/dfalster"&gt;Daniel Falster&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/rkrug"&gt;Rainer Krug&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/bmchorse"&gt;Brianna McHorse&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href = "https://github.com/mrchypark"&gt;Chan-Yub Park&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightLines": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
