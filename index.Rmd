---
title: "Reproducible computation at scale in R"
subtitle: "With a deep learning example"
author: Will Landau
output: 
  revealjs::revealjs_presentation:
    transition: none
    reveal_options:
      slideNumber: true
    template: include/template.html
    includes:
      in_header: include/header.html
    css: style.css
---

```{r, include = FALSE}
suppressMessages(suppressWarnings(library(drake)))
suppressMessages(suppressWarnings(library(tidyverse)))
unlink(".RData")
clean(destroy = TRUE, verbose = FALSE)
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = TRUE,
  error = TRUE
)
```

## Purpose: manage long runtimes

<img src = "./images/infographic.svg" style="border: none; box-shadow: none;">

## Data analysis workflows can be complicated.
<img src = "./images/workflow.png" style="border: none; box-shadow: none;">

## When you go back and change something...
<img src = "./images/change.png" style="border: none; box-shadow: none;">

## ...everything downstream is **no longer valid**.
<img src = "./images/downstream.png" style="border: none; box-shadow: none;">

## Do you rerun **everything** from scratch?

- Takes too long.
- Too frustrating.

<img src = "./images/sisyphus.svg" style="border: none; box-shadow: none; height: 375px">

<div style="font-size: 0.5em;"><a href="https://openclipart.org/detail/275842/sisyphus-overcoming-silhouette">https://openclipart.org/detail/275842/sisyphus-overcoming-silhouette</a></div>

## Do you manually hunt for pieces to update?

- Messy and prone to human error.
- Not reproducible.

<img src = "./images/mess.svg" style="border: none; box-shadow: none; height: 400px">

<div style="font-size: 0.5em;"><a href="https://openclipart.org/detail/216179/messy-desk">https://openclipart.org/detail/216179/messy-desk</a></div>

## Pipeline toolkits solve this problem.

- Sophisticated, vibrant, active space of tools: [github.com/pditommaso/awesome-pipeline](https://github.com/pditommaso/awesome-pipeline).
- Most are language-agnostic or designed for Python.
- [**`drake`**](https://github.com/ropensci/drake) is the most aggressively designed for R.
    - A focus on ordinary R functions and variables rather than cumbersome files.
    - Heavy use of the data frame, even as a substitute for the  traditional [Makefile](https://www.gnu.org/software/make).
    - Native [tidy evaluation](https://tidyeval.tidyverse.org) support.
    - A [domain-specific language (DSL)](http://adv-r.had.co.nz/dsl.html) for [creating large workflows](https://ropenscilabs.github.io/drake-manual/plans.html#large-plans).

## Example workflow: customer churn

## Use deep learning in R.

## Project files

<br>
<br>

```
make.R
R/
├── packages.R
├── functions.R
└── plan.R
data/
└── data.csv
```

## `packages.R`

```{r}

```

## `functions.R`

```{r}

```

## `plan.R`

```{r}

```

## `make.R`

```{r, eval = FALSE}

```

## Run the project.

```{r}

```

## Inspect the results.

## Update the workflow.

## Refresh the results.

## Evidence of reproducibility.

## High-performance computing.

```{r slurmclustermq, eval = FALSE}
# Use a template file and options.
drake_hpc_template_file("slurm_clustermq.tmpl") # Modify by hand.
options(
  clustermq.scheduler = "slurm",
  clustermq.template = "slurm_clustermq.tmpl"
)

# make() is the basically the same.
make(plan, jobs = 2, parallelism = "clustermq")
```

## High-performance computing.

<script src="https://fast.wistia.com/embed/medias/ycczhxwkjw.jsonp" async></script><script src="https://fast.wistia.com/assets/external/E-v1.js" async></script><div class="wistia_responsive_padding" style="padding:56.21% 0 0 0;position:relative;"><div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;"><div class="wistia_embed wistia_async_ycczhxwkjw videoFoam=true" style="height:100%;position:relative;width:100%"><div class="wistia_swatch" style="height:100%;left:0;opacity:0;overflow:hidden;position:absolute;top:0;transition:opacity 200ms;width:100%;"><img src="https://fast.wistia.com/embed/medias/ycczhxwkjw/swatch" style="filter:blur(5px);height:100%;object-fit:contain;width:100%;" alt="" onload="this.parentNode.style.opacity=1;" /></div></div></div></div>

## Resources

```{r, eval = FALSE}
install.packages("drake")                  # release
devtools::install_github("ropensci/drake") # development
```

- [Quick reference guide](https://ropensci.github.io/drake/)
- [User manual and tutorials](https://ropenscilabs.github.io/drake-manual/)
- [Example workflows](https://github.com/wlandau/drake-examples) (see also [`drake_example()`](https://ropensci.github.io/drake/reference/drake_example.html)).
- [File an issue](https://github.com/ropensci/drake/issues).
- [Contribute code](https://github.com/ropensci/drake/pulls).
- [Discuss at rOpenSci.org](https://discuss.ropensci.org).

## Today's example

<br>
<br>
<ul style = "float: left: width: 49%">
<img src = "./images/edgar.jpg" style="border: none; box-shadow: none; height: 150px">
<li><a href = "https://github.com/edgararuiz">Edgar Ruiz</a></li>
<li><a href = "https://github.com/sol-eng/tensorflow-w-r/blob/master/workflow/tensorflow-drake.Rmd">example code</a></li>
</ul>
<ul style = "float: right; width: 49%">
<img src = "./images/matt.jpg" style="border: none; box-shadow: none; height: 150px">
<li><a href = "https://github.com/mdancho84">Matt Dancho</a></li>
<li><a href = "https://blogs.rstudio.com/tensorflow/posts/2018-01-11-keras-customer-churn/">blog post</a></li>
</ul>

## Development

<br>
<ul style = "float: left: width: 49%">
<img src = "./images/ropensci.png" style="border: none; box-shadow: none; height: 150px">
<li><a href = "https://github.com/maelle">Maëlle Salmon</a></li>
<li><a href = "https://github.com/benmarwick">Ben Marwick</a></li>
<li><a href = "https://github.com/jules32">Julia Lowndes</a></li>
<li><a href = "https://github.com/gothub">Peter Slaughter</a></li>
<li><a href = "https://github.com/jennybc">Jenny Bryan</a></li>
<li><a href = "https://github.com/richfitz">Rich FitzJohn</a></li>
<li><a href = "https://github.com/stefaniebutland">Stefanie Butland</a></li>
</ul>
<ul style = "float: right; width: 49%">
<li><a href = "https://github.com/jarad">Jarad Niemi</a></li>
<li><a href = "https://github.com/krlmlr">Kirill Müller</a></li>
<li><a href = "https://github.com/HenrikBengtsson">Henrik Bengtsson</a></li>
<li><a href = "https://github.com/milesmcbain">Miles McBain</a></li>
<li><a href = "https://github.com/pat-s">Patrick Schratz</a></li>
<li><a href = "https://github.com/kendonB">Kendon Bell</a></li>
<li><a href = "https://github.com/AlexAxthelm">Alex Axthelm</a></li>
<li><a href = "https://github.com/dapperjapper">Jasper Clarkberg</a></li>
<li><a href = "https://github.com/dfalster">Daniel Falster</a></li>
<li><a href = "https://github.com/mrchypark">Chan-Yub Park</a></li>
<li><a href = "https://github.com/tiernanmartin">Tiernan Martin</a></li>

</ul>

```{r, include = FALSE}
clean(destroy = TRUE)
```
